#!/usr/bin/env bash
# init
jobname="PRV"
time="02:00:00"
mem="20Gb"
constraint="medmem"

function usage () {
echo "Usage: providentia [-u|--usage] [-c|--cores NUM_CORES (default=16)]"
echo "    [-J|--jobname JOB_NAME (default=PRV)] [-q|--queue QUEUE_NAME (default=debug)]"
echo "    [-m|--mem MEMORY (only valid on P9, default=20Gb)]"
echo "    [--constraint CONSTRAINT (default=medmem)]"
}

getopt --test 2> /dev/null
if [[ $? -ne 4 ]]; then
    echo "GNU's enhanced getopt is required to run this script"
    echo "You can usually find this in the util-linux package"
    echo "On MacOS/OS X see homebrew's package: http://brewformulas.org/Gnu-getopt"
    echo "For anyone else, build from source: http://frodo.looijaard.name/project/getopt"
    exit 1
fi

# get OS
#Mac OS X platform        
if [ "$(uname)" == "Darwin" ]; then
    OS="Mac"        
#GNU/Linux platform
elif [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
    OS="Linux"
# Windows platform
elif [ "$(expr substr $(uname -s) 1 10)" == "Windows" ] || [ "$(expr substr $(uname -s) 1 10)" == "MINGW32_NT" ] || [ "$(expr substr $(uname -s) 1 10)" == "MINGW64_NT" ]; then
    OS="Windows"
else
    echo "The OS cannot be detected. Exiting."
    exit 1
fi

# initialize conda in windows
if [ "${OS}" == "Windows" ] ; then 
    CONDA_PATH="$HOME/anaconda3"

    __conda_setup="$("$CONDA_PATH/condabin/conda" 'shell.bash' 'hook' 2> /dev/null)"
    
    if [ $? -eq 0 ]; then
        eval "$__conda_setup"
        echo "Conda initialized successfully"
    else
        if [ -f "$CONDA_PATH/etc/profile.d/conda.sh" ]; then
            . "$CONDA_PATH/etc/profile.d/conda.sh"
        else
            export PATH="$CONDA_PATH/condabin:$PATH"
        fi
    fi
    unset __conda_setup
fi

# bash strict mode: see http://redsymbol.net/articles/unofficial-bash-strict-mode/ for info
set -eo pipefail
IFS=$'\n\t'

# An option followed by a single colon ':' means that it *needs* an argument.
# An option followed by double colons '::' means that its argument is optional.
# See `man getopt'.
SHORT=uc:t:J:q:m:V
LONG=usage,cores:,time:,jobname:,queue:,mem:,constraint:,help,version,debug,clean,section:,ghost_version:,conf:,config:,config_dir:,cartopy_data_dir:,ghost_root:,nonghost_root:,exp_root:,exp_to_interp_root:,generate_file_tree,gft,disable_file_tree,dft,offline,interactive,download,dl,interpolation,interp,interpolate,slurm_job_id:,network:,species:,resolution:,start_date:,end_date:,observations_data_label:,experiments:,domain:,ensemble_options:,forecast_day:,forecast:,qa:,flags:,add_qa:,subtract_qa:,add_flags:,subtract_flags:,temporal_colocation:,spatial_colocation:,spatial_colocation_tolerance:,spatial_colocation_station_reference:,spatial_colocation_station_name:,spatial_colocation_longitude_latitude:,spatial_colocation_measurement_altitude:,spatial_colocation_validation:,spatial_colocation_validation_tolerance:,map_extent:,filter_species:,calibration_factor:,lower_bound:,upper_bound:,remove_extreme_stations:,report_type:,report_summary:,report_stations:,report_title:,report_filename:,harmonise_summary:,harmonise_stations:,active_dashboard_plots:,resampling_resolution:,statistic_mode:,statistic_aggregation:,periodic_statistic_mode:,periodic_statistic_aggregation:,timeseries_statistic_aggregation:,plot_characteristics_filename:,interp_multiprocessing:,interp_n_neighbours:,interp_reverse_vertical_orientation:,interp_chunk_size:,interp_job_array_limit:

# parse arguments
PARSED=$(getopt --options ${SHORT} \
                --longoptions ${LONG} \
                --name "$0" \
                -- "$@")         # pass all the args to this script to getopt
# exit if getopt has complained about wrong arguments to stdout
if [[ $? -ne 0 ]]; then
    exit 2
fi

# set qos depending on the mode and machine
if [[ $PARSED =~ "--interp" || $PARSED =~ "--interpolation" || $PARSED =~ "--interpolate" ]]; then
    # define core as one when it is interpolation
    cores="1"
    
    # define qos in interpolation
    if [ "${BSC_MACHINE}" == "mn5" ]; then
        queue="gp_bsces" #TODO Check if i can "gp_debug"
    else
        queue="bsc_es"
    fi
else
    # define core as twelve if it is not an interpolation
    cores="12"
    
    # define qos in every mode but interpolation
    if [ "${BSC_MACHINE}" == "mn5" ]; then
        queue="gp_debug"
    else
        queue="debug"
    fi 
fi

# reset SLURM_EXPORT_ENV so that things like srun & sbatch work out of the box
export SLURM_EXPORT_ENV=ALL

# workaround to stop driver conflict issue 
#export QT_QPA_PLATFORM_PLUGIN_PATH=/gpfs/home/bsc/${USER}/.conda/envs/providentia-env/lib/python3.9/site-packages/PyQt5/Qt5/plugins


# update key arguments for job submission
OTHEROPTS=""
while [ $# -gt 0 ]; do
  # parse equals sign in arguments
  OPT="$1"
  if [[ $OPT == *"="* ]]; then
      OPTNAME=${OPT%=*}
      OPTARG=${OPT#*=}
  else
      OPTNAME=$OPT 
      OPTARG=""
  fi
  case $OPTNAME in
        -u|--usage) shift
                    usage 
                    exit 0
                    ;;
        -c|--cores) shift
                    cores=$OPTARG;;
        -t|--time) shift
                    time=$OPTARG;;
        -J|--jobname) shift
                    jobname=$OPTARG;;
        -q|--queue) shift
                    queue=$OPTARG;;
        -m|--mem) shift
                    mem=$OPTARG;;
        --constraint) shift 
                    constraint=$OPTARG;;            
        -*) shift
            OTHEROPTS+="$OPT ";;
        * ) echo "ALL OPTIONS MUST BE PREFIXED WITH '-' or '--', AND ARGUMENTS MUST BE PREFIXED WITH '=', e.g. '--cores=10'" 
            exit 2
  esac
done

account_option="--account=bsc32"
queue_option="--qos=$queue"
memory_option="--mem=$mem"
constraint_option="--constraint=$constraint"
load_command="source bin/load_modules.sh"
interactive_alloc_command="sbatch -t $time -c $cores -J $jobname"
script_dir=$(dirname $(realpath $(dirname $0)))

# use python 3 if not in windows
if [[ "${OS}" =~ "Windows" ]] ; then 
    python_ver="3"
fi

python_command="python$python_ver -u -Wi -c 'from providentia import main;main.main()' $OTHEROPTS"

# use clean mode and exit
if [[ $PARSED =~ "--clean" ]]; then
    bash bin/clean_output.sh
    exit 0
fi

# avoid x11 forwarding when creating offline reports or doing interpolations
if [[ $PARSED =~ "--offline" || $PARSED =~ "--interp" || $PARSED =~ "--interpolation" || $PARSED =~ "--interpolate" || $PARSED =~ "--download" || $PARSED =~ "--dl" ]]; then
    salloc_command="salloc -t $time -c $cores -J $jobname"
else
    salloc_command="salloc -t $time -c $cores -J $jobname --x11"
fi

# if using debug mode then just reserve allocation, do not execute providentia
if [[ $PARSED =~ "--debug" ]]; then
    debug=true
else
    debug=false
fi

# if using interactive mode then 
if [[ $PARSED =~ "--interactive" ]]; then
    interactive=true
else
    interactive=false
fi

# if using interpolation mode then
if [[ $PARSED =~ "--interp" || $PARSED =~ "--interpolation" || $PARSED =~ "--interpolate" ]]; then
    interpolation=true
else
    interpolation=false
fi

# if using download mode then 
if [[ $PARSED =~ "--download" || $PARSED =~ "--dl" ]]; then
    download=true
else
    download=false
fi

# determine if need to just execute python if have allocation made (i.e. are in debug mode)
VALID_HOSTS="p9login1 login0 login1 login2 login3 login4 glogin1 glogin2 glogin3 glogin4"
HOST=`hostname`
if [[ " $VALID_HOSTS " =~ .*\ $HOST\ .* ]]; then
    debugexec=false
else
    debugexec=true
fi

# load modules from conda environment
# EXPORTPATH="/gpfs/home/bsc32/bsc32781/.conda/envs/myenv/lib/python3.9/site-packages"
# export PYTHONPATH=${EXPORTPATH}:${PYTHONPATH}

# get IP (different method for each OS)
if [ "${OS}" == "Mac" ]; then
    ip=${LOCAL_IP:-`ipconfig getifaddr en0`}
elif [ "${OS}" == "Linux" ]; then
    ip=$(hostname --ip-address)
elif [ "${OS}" == "Windows" ]; then
    ip=${LOCAL_IP:-`ipconfig.exe | grep -im1 'IPv4 Address' | cut -d ':' -f2`}
fi

# if download mode is executed from the remote machines, exit
if $download; then
    if [[ "${BSC_MACHINE}" == "mn5" || "${BSC_MACHINE}" == "nord3v2" || "${BSC_MACHINE}" == "84.88.185.48" ]]; then
        echo "Download mode only available in local. Exiting..."
        exit 1
    fi
fi

# execution
# Marenostrum5
if [ "${BSC_MACHINE}" == "mn5" ]; then

    echo "INFO: Running on MN5..."

    # load modules from conda environment
    active_env=false
    module load anaconda
    eval "$(conda shell.bash hook)"
    conda config --set env_prompt '($(basename {default_env})) '
    if ! { conda config --show-sources | grep '/gpfs/projects/bsc32/repository/apps/conda_envs/'; } >/dev/null 2>&1; then
        conda config --append envs_dirs /gpfs/projects/bsc32/repository/apps/conda_envs/
    fi
    if { conda env list | grep 'providentia-env_v2.4.0'; } >/dev/null 2>&1; then 
        echo "Activating conda environment in /gpfs/projects/bsc32/repository/apps/conda_envs/providentia-env_v2.4.0..."
        conda activate providentia-env_v2.4.0
        active_env=true
    else 
        echo "Environment not found in /gpfs/projects/bsc32/repository/apps/conda_envs/"
    fi

    if $active_env; then
        if $interactive; then
            echo "OPTIONS: cores: ${cores}, jobname: ${jobname}, queue: ${queue}, constraint: ${constraint}"
            echo "Starting interactive jupyter session."
            echo "Check 'interactive.out' for information on how to connect to session."
            
            if [[ "${constraint}" == "lowmem" ||  "${constraint}" == "medmem" ]]; then
                eval "${interactive_alloc_command} ${account_option} ${queue_option} bin/interactive.sh"
            else
                eval "${interactive_alloc_command} ${account_option} ${constraint_option} ${queue_option} bin/interactive.sh"
            fi

        elif $debug; then
            echo "OPTIONS: cores: ${cores}, jobname: ${jobname}, queue: ${queue}, constraint: ${constraint}"
            echo "Entering debug mode"
            if [[ "${constraint}" == "lowmem" ||  "${constraint}" == "medmem" ]]; then
                eval "${salloc_command} ${account_option} ${queue_option}"
            else
                eval "${salloc_command} ${account_option} ${constraint_option} ${queue_option}"
            fi
        
        elif $interpolation; then
            echo "OPTIONS: cores: ${cores}, jobname: ${jobname}, queue: ${queue}, mem: ${mem}"
            echo "Loading dependencies..."
            eval "${load_command}"
            jobid=$(eval "sbatch ${account_option} ${queue_option} bin/experiment_interpolation_submit_mn5.sh $OTHEROPTS | awk '{print \$4}'")
            echo "Check submission info in 'logs/interpolation/management_logs/$jobid.out'"

        else
            if $debugexec; then
                eval "srun ${account_option} ${python_command}"
            else
                echo "OPTIONS: cores: ${cores}, jobname: ${jobname}, queue: ${queue}, constraint: ${constraint}"
                if [[ "${constraint}" == "lowmem" ||  "${constraint}" == "medmem" ]]; then
                    eval "${salloc_command} ${account_option} ${queue_option} srun ${python_command}"
                else
                    eval "${salloc_command} ${account_option} ${constraint_option} ${queue_option} srun ${python_command}"
                fi
            fi
        fi
    fi

# Nord3v2
elif [ "${BSC_MACHINE}" == "nord3v2" ] || [ "${BSC_MACHINE}" = "amd" ]; then
    echo "INFO: Running on ${BSC_MACHINE}..."
    if $interactive; then
        echo "OPTIONS: cores: ${cores}, jobname: ${jobname}, queue: ${queue}, constraint: ${constraint}"
        echo "Starting interactive jupyter session."
        echo "Check 'interactive.out' for information on how to connect to session."
        eval "${load_command}"
        if [[ "${constraint}" == "lowmem" ]]; then
            eval "${interactive_alloc_command} ${queue_option} bin/interactive.sh"
        else
            eval "${interactive_alloc_command} ${constraint_option} ${queue_option} bin/interactive.sh"
        fi

    elif $debug; then
        echo "OPTIONS: cores: ${cores}, jobname: ${jobname}, queue: ${queue}, constraint: ${constraint}"
        echo "Entering debug mode"
        eval "${load_command}"
        if [[ "${constraint}" == "lowmem" ]]; then
            eval "${salloc_command} ${queue_option}"
        else
            eval "${salloc_command} ${constraint_option} ${queue_option}"
        fi

     elif $interpolation; then
            echo "OPTIONS: cores: ${cores}, jobname: ${jobname}, queue: ${queue}, mem: ${mem}"
            echo "Loading dependencies..."
            eval "${load_command}"
            jobid=$(eval "sbatch ${account_option} ${queue_option} bin/experiment_interpolation_submit.sh $OTHEROPTS | awk '{print \$4}'")
            echo "Check submission info in 'logs/interpolation/management_logs/$jobid.out'"

    else
        if $debugexec; then
            eval "srun ${python_command}"
        else
            echo "OPTIONS: cores: ${cores}, jobname: ${jobname}, queue: ${queue}, constraint: ${constraint}"
            eval "${load_command}"
            if [[ "${constraint}" == "lowmem" ]]; then
                eval "${salloc_command} ${queue_option} srun ${python_command}"
            else
                eval "${salloc_command} ${constraint_option} ${queue_option} srun ${python_command}"
            fi
        fi
    fi

# Hub
elif [ "${ip}" == "84.88.185.48" ]; then
    echo "INFO: Running on the hub..."
    eval "${load_command}"
    if $interactive; then
        echo "Starting interactive jupyter session."
        export PYTHONPATH=$(pwd):${PYTHONPATH}
        jupyter-lab

    else
        eval "${python_command}"
    fi

# Local machines (Workstations, dust02 machine and personal laptops)
else
    echo "INFO: Running on a local machine..."
    
    # load modules from conda environment
    active_env=false
    eval "$(conda shell.bash hook)"
    if { conda env list | grep 'providentia-env_2.4.0'; } >/dev/null 2>&1; then 
        echo "Activating environment..."
        conda activate providentia-env_2.4.0
        active_env=true
    else
        # create environment if it does not exist
        echo "Environment providentia-env_2.4.0 does not exist."; 
        echo "Creating environment..."
        conda create -n providentia-env_2.4.0 -y python=3.11.5
        conda activate providentia-env_2.4.0
        conda install -c conda-forge cartopy -y
        conda install -c conda-forge jupyterlab -y
        pip install -r requirements.txt
        active_env=true
    fi

    if $interactive; then
        echo "Starting interactive jupyter session."
        export PYTHONPATH=$(pwd):${PYTHONPATH}
        jupyter-lab --port 8888 --ip 0.0.0.0 --allow-root
    elif $interpolation; then
        unique_id=$(printf "%06d\n" $((RANDOM % 1000000)))
        echo "Check submission info in 'logs/interpolation/management_logs/$unique_id.out'"
        eval "${python_command}" > logs/interpolation/management_logs/$unique_id.out 2>&1 --slurm_job_id=$unique_id
    else
        eval "${python_command}"
    fi
fi
